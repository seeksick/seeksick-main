# ⚖️ 가중 평균 Late Fusion 최종 구현

**업데이트:** 2025년 10월 27일  
**버전:** main.py v3.0 (가중 평균 + 5가지 확률 출력)

---

## ✨ 최종 구현 내용

### 1. **가중 평균 Late Fusion**

#### ⚖️ 가중치 설정

```python
얼굴 (ResNet18):  0.350  (정확도 74%, happy/surprised 특히 강함)
음성 (Wav2Vec2):  0.324  (정확도 65%)
텍스트 (KoBERT):  0.327  (정확도 66%)
─────────────────────────
합계:              1.000
```

#### 📐 계산 방식

**하이브리드 방식 (α = 0.6)**

```python
가중치 = (0.6 × 성능비례) + (0.4 × 균등)

# 성능 비례 부분
perf_face = 74 / 205 = 0.361
perf_voice = 65 / 205 = 0.317
perf_text = 66 / 205 = 0.322

# 균등 부분
equal = 1/3 = 0.333

# 최종 가중치
W_face = 0.6 × 0.361 + 0.4 × 0.333 = 0.350
W_voice = 0.6 × 0.317 + 0.4 × 0.333 = 0.324
W_text = 0.6 × 0.322 + 0.4 × 0.333 = 0.327
```

**특징:**
- ✅ 성능 차이 반영 (얼굴 모델 약간 우대)
- ✅ 편향 최소화 (최대 3% 차이)
- ✅ 균형적이고 공정함

---

### 2. **5가지 감정 확률 모두 출력**

#### 📊 출력 형식

```
================================================================================
🎯 가중 평균 LATE FUSION 결과 (5초 통합)
================================================================================

⚖️  가중치 설정:
   👤 얼굴: 0.350 (정확도 74%)
   🎤 음성: 0.324 (정확도 65%)
   📝 텍스트: 0.327 (정확도 66%)

📊 사용된 모달리티:
   👤 얼굴: 30개 결과
   🎤 음성: 2개 결과
   📝 텍스트: 1개 결과

   총 3개 모달리티, 33개 결과 통합

================================================================================
📈 5가지 감정 확률 분포:
================================================================================
   😊 happy        [██████████████████████████████] 75.0% ⭐
   😮 surprised    [████] 9.9%
   😢 depressed    [███] 8.5%
   😠 angry        [█] 3.6%
   😐 neutral      [█] 3.0%

================================================================================
   🏆 최종 감정: HAPPY (신뢰도: 75.0%)
================================================================================
```

**특징:**
- ✅ 5가지 감정 **모두** 표시 (확률 순서대로 정렬)
- ✅ 바 그래프로 시각화
- ✅ 최고 확률 감정은 빨간색 + 별표(⭐)
- ✅ 이모지로 직관적 표현

---

## 🔬 Late Fusion 알고리즘

### 단계별 계산

#### Step 1: 모달리티별 평균

```python
# 5초 동안 수집된 결과들의 평균
Face_avg = mean([얼굴_1, 얼굴_2, ..., 얼굴_N])
Voice_avg = mean([음성_1, 음성_2, ...])
Text_avg = mean([텍스트_1, 텍스트_2, ...])
```

#### Step 2: 가중 평균 (Late Fusion)

```python
Fused = (Face_avg × 0.350 + 
         Voice_avg × 0.324 + 
         Text_avg × 0.327) / total_weight

# total_weight = 사용된 모달리티 가중치 합
# 3개 모두: 1.000
# 2개만: 0.650~0.677
# 1개만: 0.324~0.350
```

#### Step 3: 정규화

```python
Fused = Fused / total_weight  # 확률 합 = 1.0 보장
```

#### Step 4: 최종 감정 추출

```python
Final_emotion = argmax(Fused)  # 가장 높은 확률
```

---

## 📊 실제 예제

### 예제 1: 행복한 감정 (3개 모달리티)

**입력:**
```python
# 얼굴 평균 (30개 프레임)
Face = [0.75, 0.08, 0.11, 0.04, 0.03]
       [happy, depressed, surprised, angry, neutral]

# 음성 평균 (2개)
Voice = [0.60, 0.15, 0.15, 0.05, 0.05]

# 텍스트 평균 (1개)
Text = [0.90, 0.03, 0.04, 0.02, 0.01]
```

**가중 평균 계산:**
```python
Fused = Face × 0.350 + Voice × 0.324 + Text × 0.327

happy = 0.75×0.350 + 0.60×0.324 + 0.90×0.327
      = 0.2625 + 0.1944 + 0.2943
      = 0.7512

depressed = 0.08×0.350 + 0.15×0.324 + 0.03×0.327
          = 0.0280 + 0.0486 + 0.0098
          = 0.0864

surprised = 0.11×0.350 + 0.15×0.324 + 0.04×0.327
          = 0.0385 + 0.0486 + 0.0131
          = 0.1002

angry = 0.04×0.350 + 0.05×0.324 + 0.02×0.327
      = 0.0140 + 0.0162 + 0.0065
      = 0.0367

neutral = 0.03×0.350 + 0.05×0.324 + 0.01×0.327
        = 0.0105 + 0.0162 + 0.0033
        = 0.0300

# 합계 검증
Sum = 0.7512 + 0.0864 + 0.1002 + 0.0367 + 0.0300 = 1.0045 ≈ 1.0 ✓
```

**최종 결과:**
```
😊 happy:      75.0% ⭐
😮 surprised:  10.0%
😢 depressed:   8.6%
😠 angry:       3.7%
😐 neutral:     3.0%

최종 감정: HAPPY (75.0%)
```

---

### 예제 2: 우울한 감정 (2개 모달리티)

**입력:**
```python
# 얼굴 없음!
Voice = [0.09, 0.725, 0.11, 0.04, 0.035]
Text = [0.05, 0.85, 0.05, 0.03, 0.02]
```

**가중 평균 계산:**
```python
total_weight = 0.324 + 0.327 = 0.651

Fused = (Voice × 0.324 + Text × 0.327) / 0.651

depressed = (0.725×0.324 + 0.85×0.327) / 0.651
          = (0.2349 + 0.2780) / 0.651
          = 0.7880

happy = (0.09×0.324 + 0.05×0.327) / 0.651
      = (0.0292 + 0.0164) / 0.651
      = 0.0700

... (나머지 계산)
```

**최종 결과:**
```
😢 depressed:  78.8% ⭐
😮 surprised:   8.0%
😊 happy:       7.0%
😠 angry:       3.5%
😐 neutral:     2.7%

최종 감정: DEPRESSED (78.8%)
```

---

## 💻 구현 코드

### LateFusion 클래스

```python
class LateFusion:
    def __init__(self, interval: float = 5.0):
        self.interval = interval
        self.face_buffer = []
        self.voice_buffer = []
        self.text_buffer = []
        
        # 가중치 설정 (하이브리드, α = 0.6)
        accuracies = {'face': 74.0, 'voice': 65.0, 'text': 66.0}
        total_acc = sum(accuracies.values())
        
        perf_weights = {k: v/total_acc for k, v in accuracies.items()}
        equal_weight = 1.0 / 3.0
        alpha = 0.6
        
        self.weights = {
            'face': alpha * perf_weights['face'] + (1-alpha) * equal_weight,
            'voice': alpha * perf_weights['voice'] + (1-alpha) * equal_weight,
            'text': alpha * perf_weights['text'] + (1-alpha) * equal_weight
        }
    
    def fuse_emotions(self):
        fused_probs = np.zeros(5)
        total_weight = 0.0
        
        # 가중 평균
        if self.face_buffer:
            face_avg = np.mean(self.face_buffer, axis=0)
            fused_probs += face_avg * self.weights['face']
            total_weight += self.weights['face']
        
        if self.voice_buffer:
            voice_avg = np.mean(self.voice_buffer, axis=0)
            fused_probs += voice_avg * self.weights['voice']
            total_weight += self.weights['voice']
        
        if self.text_buffer:
            text_avg = np.mean(self.text_buffer, axis=0)
            fused_probs += text_avg * self.weights['text']
            total_weight += self.weights['text']
        
        # 정규화
        fused_probs /= total_weight
        
        # 최종 감정
        final_emotion = EMOTIONS[np.argmax(fused_probs)]
        
        return final_emotion, fused_probs, available_modalities
```

---

## 🎯 장점

### 1. **공정성**
- 성능 좋은 모델 우대 (얼굴 35%)
- 하지만 편향 최소화 (최대 3% 차이)
- 모든 모달리티 기여

### 2. **투명성**
- 5가지 감정 확률 모두 공개
- 가중치 명시
- 사용된 모달리티 표시

### 3. **해석 가능성**
- 어떤 감정이 얼마나 강한지 명확
- 2순위, 3순위 감정도 확인 가능
- 디버깅 용이

### 4. **안정성**
- 확률 합 = 1.0 보장
- 수학적으로 검증됨
- 일부 모달리티 없어도 작동

---

## 📈 성능 비교

### 균등 가중치 vs 가중 평균

#### 시나리오: 얼굴만 happy 강하게 예측

**입력:**
```python
Face:  [0.9, 0.02, 0.03, 0.03, 0.02]  # happy 강함
Voice: [0.3, 0.4, 0.15, 0.1, 0.05]    # depressed 약함
Text:  [0.35, 0.35, 0.15, 0.1, 0.05]  # 혼재
```

**균등 가중치 (1/3, 1/3, 1/3):**
```
happy: (0.9 + 0.3 + 0.35) / 3 = 0.517 (51.7%)
```

**가중 평균 (0.35, 0.324, 0.327):**
```
happy: 0.9×0.35 + 0.3×0.324 + 0.35×0.327
     = 0.315 + 0.097 + 0.114
     = 0.526 (52.6%)  ✓ 약간 개선
```

**효과:**
- 성능 좋은 얼굴 모델의 예측이 더 반영됨
- 하지만 극단적이지 않음 (1% 차이)

---

## 🧪 테스트 방법

### 테스트 스크립트 실행

```bash
python3 test_weighted_fusion.py
```

**출력:**
- 가중치 계산 과정
- 2가지 시나리오 테스트
- 5가지 감정 확률 출력
- 빨간색 시각화

### 실제 프로그램 실행

```bash
python3 main.py
```

**동작:**
1. 웹캠 + 마이크 시작
2. 실시간 감정 분석
3. **5초마다** 가중 평균 Late Fusion 결과 출력
4. 5가지 감정 확률 모두 표시

---

## ⚙️ 설정 조정

### α 값 변경

```python
# main.py - LateFusion.__init__()
alpha = 0.6  # 기본값

# α 값에 따른 효과:
# α = 0.0: 완전 균등 (0.333, 0.333, 0.333)
# α = 0.4: 약간 성능 반영 (0.344, 0.327, 0.329)
# α = 0.6: 균형적 (0.350, 0.324, 0.327)  ← 현재
# α = 0.8: 성능 우선 (0.356, 0.320, 0.324)
# α = 1.0: 완전 성능 기반 (0.361, 0.317, 0.322)
```

### Fusion 간격 변경

```python
# main.py - 전역 상수
FUSION_INTERVAL = 5.0  # 5초

# 변경 예:
FUSION_INTERVAL = 3.0  # 3초마다 융합
FUSION_INTERVAL = 10.0  # 10초마다 융합
```

---

## 📝 요약

### ✅ 구현 완료

1. **가중 평균 Late Fusion**
   - 얼굴: 35.0%
   - 음성: 32.4%
   - 텍스트: 32.7%

2. **5가지 감정 확률 모두 출력**
   - 확률 순서대로 정렬
   - 바 그래프 시각화
   - 빨간색 강조

3. **투명성 및 해석 가능성**
   - 가중치 표시
   - 모달리티 정보 표시
   - 확률 합 검증

### 🎯 특징

- ✅ 성능 기반 가중치 (74%, 65%, 66%)
- ✅ 편향 최소화 (최대 3% 차이)
- ✅ 완전한 정보 공개 (5가지 확률)
- ✅ 유연성 (1~3개 모달리티)
- ✅ 수학적 검증 (확률 합 = 1.0)

---

**지금 실행해보세요!**

```bash
python3 main.py
```

**5초마다 5가지 감정 확률이 모두 빨간색으로 출력됩니다!** 🎯🔴

---

**작성:** 2025년 10월 27일  
**버전:** main.py v3.0 (가중 평균 + 5가지 확률 출력)  
**참고:** test_weighted_fusion.py

